"use strict";let date,tipsEnabled,tips,highPrecCalInTips,magLimitTip=5.3,stars=brightStars(),conLab=constellationLabel(),conLine=constellationLines(),magLimit=5.3,milkyPoly={poly:mw_poly(),sb:mw_sb()};var animate_id,animateDtStep=1,frameRate=40;function init(){$("#wrapper").show();var t=new Date;let e=t.getUTCFullYear(),a=t.getUTCMonth()+1,n=t.getUTCDate(),r=t.getUTCHours(),i=t.getUTCMinutes(),o=t.getUTCSeconds()+.001*t.getUTCMilliseconds(),d=generateDateString(e,a,n),l=generateTimeString(r,i,o),s=getDm(e,a,n,0)+(r+i/60+o/3600)/24,c=s/36525,h=DeltaT(c);date={yyyy:e,mm:a,dd:n,h:r,m:i,s:o,dateString:d,timeString:l,D:s,T:c,dT:h},tipsEnabled=!0,tips=[[],[],[]],highPrecCalInTips=!0,$("#canvasNorth").on("click",(function(t){displayPopup(t,"canvasNorth")})),$("#canvasCentral").on("click",(function(t){displayPopup(t,"canvasCentral")})),$("#canvasSouth").on("click",(function(t){displayPopup(t,"canvasSouth")})),starCharts()}function displayChangeTime(){var t="#changeTime";$("button.menu").attr("disabled",!0),$(t).empty(),$(t).slideDown();var e="<h2>Change Date and Time</h2>";$(t).append(e),e='<form name="changeTime" action="" method="get">',e+="<table>",e+='<tr><td>Year: <input type="number" id="yearIn" step="1" min=-200000 max=200000 /></td>',e+='<td>Month: <input type="number" id="monthIn" step="1" min=1 max=12 /></td>',e+='<td>Day: <input type="number" id="dayIn" step="1" min=1 max=31 /></td></tr>',e+='<tr><td>Hour: <input type="number" id="hourIn" step="1" min=0 max=23 /></td>',e+='<td>Minute: <input type="number" id="minuteIn" step="1" min=0 max=59 /></td>',e+='<td>Second: <input type="number" id="secondIn" step="any" min=0 max=60 /> UT</td></tr>',e+="</table><br />",e+='<p><input type="button" value="Submit" onclick="changeTimeAction(this.form)" /></p>',e+="</form>",$(t).append(e),e='<div id="changeTimeErrorlocs"></div>',$(t).append(e),$("#yearIn").val(date.yyyy),$("#monthIn").val(date.mm),$("#dayIn").val(date.dd),$("#hourIn").val(date.h),$("#minuteIn").val(date.m),$("#secondIn").val(date.s.toFixed(3))}function changeTimeAction(t){var e=parseInt(t.yearIn.value),a=parseInt(t.monthIn.value),n=parseInt(t.dayIn.value),r=parseInt(t.hourIn.value),i=parseInt(t.minuteIn.value),o=parseFloat(t.secondIn.value),d="#changeTimeErrorlocs";$(d).empty();var l=-2e5,s=2e5,c="Invalid year! Please enter an integer between "+l+" and "+s+". Note that 0 means 1 BCE, -1 means 2 BCE and so on. Note that the positions of the Sun, Moon and planets are only accurate for years between -3000 and 3000.";if(sanityCheck(e,"#yearIn",l,s,c,d),l=1,s=12,c="Invalid month! Month must be an integer between 1 and 12.",sanityCheck(a,"#monthIn",l,s,c,d),l=1,s=31,c="Invalid day! Day must be an integer between 1 and 31.",sanityCheck(n,"#dayIn",l,s,c,d),l=0,s=23,c="Invalid hour! Hour must be an integer between 0 and 23.",sanityCheck(r,"#hourIn",l,s,c,d),l=0,s=59,c="Invalid minute! Minute must be an integer between 0 and 59.",sanityCheck(i,"#minuteIn",l,s,c,d),l=0,s=60,c="Invalid second! Second must be a number between 0 and 60.",sanityCheck(o,"#secondIn",l,s,c,d),""==$(d).text()){var h="#changeTime";$(h).slideUp(),$(h).empty,$("button.menu").attr("disabled",!1);var p=getDm(e,a,n,0),m=CalDat(p),u=generateTimeString(r,i,o),y=(p+=(r+i/60+o/3600)/24)/36525,f=DeltaT(y);date={yyyy:m.yy,mm:m.mm,dd:m.dd,h:r,m:i,s:o,dateString:m.dateString,timeString:u,D:p,T:y,dT:f},starCharts()}}function starCharts(){if(Math.abs(date.yyyy)>3e3){if(""==$(".warning").text()){let t='<p style="color:red;">Warning: Positions of the Sun, Moon and planets are not accurate at this time.</p>';$(".warning").append(t)}}else""!=$(".warning").text()&&$(".warning").empty();let t=Math.PI/12,e=Math.PI/180,a=$("#rotateNorth").val()*e,n=$("#raCentral").val()*t,r=$("#rotateSouth").val()*e,i=setupDrawingParameters();addLegend(i),i.showPlanets=$("#showPlanets").hasClass("active"),i.showPlanets&&(i.planets=sunMoonPlanets(date.T+date.dT)),i.showEcliptic=$("#showEcliptic").hasClass("active"),i.showGalactic=$("#showGalactic").hasClass("active"),i.showMilkyWay=$("#showMilkyWay").hasClass("active"),i.showConLab=$("#showConLab").hasClass("active");let o=date.T+date.dT;Math.abs(o-stars[0].Tepoch)>.5&&recomputeStarPos(o,stars);let d={timeId:"timeNorth",canvasId:"canvasNorth",projection:"stereographic",centralRa:a,centralDec:.5*Math.PI,angRadius:.5*Math.PI,raGrid:[0,23*t,2*t],decGrid:[-80*e,81*e,20*e],pDraw:i};drawStarChart(d),d={timeId:"timeCentral",canvasId:"canvasCentral",projection:"Mollweide",centralRa:n,centralDec:0,raGrid:[0,23*t,2*t],decGrid:[-80*e,81*e,20*e],pDraw:i},drawStarChart(d),d={timeId:"timeSouth",canvasId:"canvasSouth",projection:"stereographic",centralRa:r,centralDec:-.5*Math.PI,angRadius:.5*Math.PI,raGrid:[0,23*t,2*t],decGrid:[-80*e,81*e,20*e],pDraw:i},drawStarChart(d)}function drawStarChart(t){let e=date.dateString+" "+date.timeString+" UT";$("#"+t.timeId).text(e);let a=document.getElementById(t.canvasId),n=a.getContext("2d"),r=a.width,i=a.height;var o;n.clearRect(0,0,r,i),drawChartBoundaryAndGrid(n,a,t),t.pDraw.showMilkyWay&&(drawMilkyWay(n,t),n.setLineDash([]),n.strokeStyle="#ff4dff"),t.pDraw.showGalactic&&drawCircle(n,3.366012906575397,.4734787372451951,t),t.pDraw.showEcliptic&&(o=getEclipticNorthPole(date.T+date.dT),n.setLineDash([]),n.strokeStyle="brown",drawCircle(n,o.ra,o.dec,t)),drawStars(n,a,t),t.pDraw.showPlanets&&drawPlanets(n,a,t),t.pDraw.showConLab&&drawConstellationLabel(n,t)}function drawChartBoundaryAndGrid(t,e,a){let n,r,i=.465*Math.max(e.width,e.height),o=.5*e.width,d=.5*e.height;a.r=i,a.r2=i*i,a.xc=o,a.yc=d;let l,s,c,h,p,m,u,y=$("#showPrecession").hasClass("active");if(y){var f=date.T+date.dT;l=precession_matrix(f,-f)}r=180;let b,M=Math.PI/(r-1);for(t.setLineDash([]),m=a.raGrid[0];m<=a.raGrid[1];m+=a.raGrid[2])for(s=m-2*Math.PI*Math.floor(.5*m/Math.PI),Math.abs(s)<.001?t.strokeStyle=a.pDraw.raGridColor[0]:Math.abs(s-.5*Math.PI)<.001?t.strokeStyle=a.pDraw.raGridColor[1]:Math.abs(s-Math.PI)<.001?t.strokeStyle=a.pDraw.raGridColor[2]:Math.abs(s-1.5*Math.PI)<.001?t.strokeStyle=a.pDraw.raGridColor[3]:t.strokeStyle=a.pDraw.raGridColor[4],c=-.5*Math.PI,y&&(b=precessed_ra_dec(s,c,l),s=b.ra,c=b.dec),n=1;n<r;n++)h=m,p=n*M-.5*Math.PI,y&&(b=precessed_ra_dec(h,p,l),h=b.ra,p=b.dec),addLine(t,s,c,h,p,a),s=h,c=p;let g=2*M;for(u=a.decGrid[0];u<=a.decGrid[1];u+=a.decGrid[2])for(c=u,s=0,y&&(b=precessed_ra_dec(s,c,l),s=b.ra,c=b.dec),n=1;n<r;n++)p=u,h=n*g,y&&(b=precessed_ra_dec(h,p,l),h=b.ra,p=b.dec),addLine(t,s,c,h,p,a),s=h,c=p;switch(a.projection){case"stereographic":t.beginPath(),t.setLineDash([]),t.arc(o,d,i,0,2*Math.PI),t.strokeStyle="black",t.stroke();break;case"Mollweide":r=100;let e=2*Math.PI/(r-1);for(t.beginPath(),t.setLineDash([]),t.moveTo(o-i,d),n=1;n<r;n++){let a=n*e-Math.PI,r=o+i*Math.cos(a),l=d-.5*i*Math.sin(a);t.lineTo(r,l)}t.strokeStyle="black",t.stroke()}let v,x,S,T,I,C=Math.PI/180;if(t.txtAlign="center",t.fillStyle="black",t.font=15..toString()+"px Arial","canvasNorth"==a.canvasId)for(I=-parseFloat($("#rotateNorth").val())*C,m=0;m<24;m+=2)v=o-1.04*i*Math.cos(I),x=d-1.04*i*Math.sin(I)+7.5,S=m.toString()+"h",T=.5*t.measureText(S).width,t.fillText(S,v-T,x),I+=30*C;else if("canvasSouth"==a.canvasId)for(I=-parseFloat($("#rotateSouth").val())*C,m=0;m<24;m+=2)v=o+1.04*i*Math.cos(I),x=d-1.04*i*Math.sin(I)+7.5,S=m.toString()+"h",T=.5*t.measureText(S).width,t.fillText(S,v-T,x),I+=30*C}function drawStars(t,e,a){var n,r;tipsEnabled&&((n=new Array(stars.length)).fill(!0),r="timeNorth"==a.timeId?0:"timeCentral"==a.timeId?1:2,tips[r].length=0);var i=$("#showConLines").hasClass("active");(i||tipsEnabled)&&drawConstellationLinesAndAddTips(t,n,i,r,a);var o,d,l=a.pDraw;t.fillStyle="black";var s=2*Math.PI;for(o=0;o<stars.length;o++){var c=getXY(stars[o].ra,stars[o].dec,a);c.inChart&&stars[o].mag<magLimit&&(d=l.starMagA*stars[o].mag+l.starMagB,d=Math.max(d,1),t.beginPath(),t.arc(c.x,c.y,d,0,s),t.fill(),tipsEnabled&&stars[o].mag<magLimitTip&&n[o]&&(n[o]=!1,d=Math.max(d,3),tips[r].push({x:c.x,y:c.y,r2:d*d,object:"star",starInd:o})))}tipsEnabled&&(n.length=0)}function recomputeStarPos(t,e){var a=e[0].Tepoch,n=t-a;e[0].epoch="",e[0].Tepoch=t;precession_matrix(a,n);for(var r=1;r<e.length;r++){var i=e[r].x+e[r].vx*n,o=e[r].y+e[r].vy*n,d=e[r].z+e[r].vz*n,l=Math.sqrt(i*i+o*o+d*d);e[r].dist2000<99e3&&(e[r].mag=e[r].mag2000+5*Math.LOG10E*Math.log(l/e[r].dist2000)),e[r].x=i,e[r].y=o,e[r].z=d,e[r].ra=Math.atan2(o,i),e[r].dec=Math.asin(d/l)}}function drawConstellationLinesAndAddTips(t,e,a,n,r){t.strokeStyle="#1B9722";var i,o,d=r.pDraw;t.setLineDash([]);for(var l=0;l<conLine.length;l++)$.each(conLine[l],(function(l,s){if("name"!=l&&"abbr"!=l){var c,h,p,m,u;h=stars[s[0]].ra,m=stars[s[0]].dec,tipsEnabled&&e[s[0]]&&(u=getXY(h,m,r)).inChart&&(i=s[0],e[i]=!1,o=d.starMagA*stars[i].mag+d.starMagB,o=Math.max(o,3),tips[n].push({x:u.x,y:u.y,r2:o*o,object:"star",starInd:i}));for(var y=1;y<s.length;y++)c=h,p=m,h=stars[s[y]].ra,m=stars[s[y]].dec,a&&addLine(t,c,p,h,m,r),tipsEnabled&&e[s[y]]&&(u=getXY(h,m,r)).inChart&&(i=s[y],e[i]=!1,o=d.starMagA*stars[i].mag+d.starMagB,o=Math.max(o,3),tips[n].push({x:u.x,y:u.y,r2:o*o,object:"star",starInd:i}))}}))}function drawCircle(t,e,a,n){for(var r=Math.cos(e)*Math.cos(a),i=Math.sin(e)*Math.cos(a),o=Math.sin(a),d=-i,l=r,s=Math.sqrt(d*d+l*l),c=-(l/=s)*o,h=(d/=s)*o,p=r*l-i*d,m=2*Math.PI/179,u=d,y=l,f=0,b=Math.atan2(y,u),M=Math.asin(f),g=1;g<180;g++){var v=g*m,x=Math.cos(v),S=Math.sin(v);u=x*d+S*c,y=x*l+S*h,f=0*x+S*p;var T=Math.atan2(y,u),I=Math.asin(f);addLine(t,b,M,T,I,n),b=T,M=I}}function drawMilkyWay(t,e){drawMW_polypons(t,milkyPoly,e)}function drawLineInChart(t,e,a){for(let n=2;n<e.length;n++)addLine(t,e[n-1].ra,e[n-1].dec,e[n].ra,e[n].dec,a)}function drawMW_polypons(t,e,a){const n="#7FFFD4";if(t.save(),"stereographic"==a.projection)t.beginPath(),t.arc(a.xc,a.yc,a.r,0,2*Math.PI),t.clip(),drawMW_polypons_stereographic(t,e,a,.7,n);else{t.beginPath();let r=100,i=a.xc,o=a.yc,d=a.r,l=2*Math.PI/(r-1);t.beginPath(),t.moveTo(i-d,o);for(let e=1;e<r;e++){let a=e*l-Math.PI,n=i+d*Math.cos(a),r=o-.5*d*Math.sin(a);t.lineTo(n,r)}t.clip(),drawMW_polypons_mollweide(t,e,a,.7,n)}t.restore()}function drawMW_polypons_stereographic(t,e,a,n,r){t.fillStyle=r,t.strokeStyle=r,t.lineWidth=.2,e.poly.forEach((function(r,i){let o=r.map((t=>getXYstereographic(t[0],t[1],a)));if(!o.reduce(((t,e)=>t||e.inChart),!1))return;let d=o.length;t.beginPath(),t.moveTo(o[0].x,o[0].y);for(let e=1;e<d;e++)t.lineTo(o[e].x,o[e].y);t.globalAlpha=n*e.sb[i],t.stroke(),t.fill()}))}function drawMW_polypons_mollweide(t,e,a,n,r){t.fillStyle=r,t.strokeStyle=r,t.lineWidth=.2;let i=a.centralRa-Math.PI;e.poly.forEach((function(r,o){let d=r.map((t=>getXYmollweide(t[0],t[1],a))),l=d.length,s=[];t.beginPath(),t.moveTo(d[0].x,d[0].y);let c=0,h=0;for(let e=1;e<l;e++){let n=p(d[e-1],d[e],r[e-1][0],r[e][0]);if(n.cross){c++,h=n.sign;let e=n.bdx1,a=n.bdx2;c%2==0&&(e=n.bdx2,a=n.bdx1),t.lineTo(e,n.bdy),s.push([a,n.bdy])}let i=d[e].x,o=d[e].y;if(c%2==1&&(i+=2*a.r*h*Math.cos(d[e].theta)),t.lineTo(i,o),c>0){let t=d[e].x;c%2==0&&(t+=2*a.r*h*Math.cos(d[e].theta)),s.push([t,o])}}if(t.globalAlpha=e.sb[o]*n,t.fill(),c>0){l=s.length,t.beginPath(),t.moveTo(s[0][0],s[0][1]);for(let e=1;e<l;e++)t.lineTo(s[e][0],s[e][1]);t.lineTo(s[0][0],s[0][1]),t.fill()}function p(t,e,n,r){let o=(n-i)/Math.PI,d=(r-i)/Math.PI,l=(n-r)/Math.PI;o-=2*Math.floor(.5*(o+1)),d-=2*Math.floor(.5*(d+1)),l-=2*Math.floor(.5*(l+1));let s=Math.abs(o)+Math.abs(d)-Math.abs(l),c=o*d<0&&s<1e-5,h=0,p=0,m=0,u=0;if(c){let n=(t.x-a.xc)/a.r,r=(e.x-a.xc)/a.r,i=(t.y-a.yc)/a.r,o=(e.y-a.yc)/a.r;u=n>0?1:-1,r+=2*u*Math.cos(e.theta);var y=r-n,f=o-i;let d=n*y+4*i*f,l=1-n*n-4*i*i,s=l/(d+Math.sqrt(d*d+l*(y*y+4*f*f))),c=n+s*y,b=i+s*f;h=a.xc+a.r*c,m=a.xc-a.r*c,p=a.yc+a.r*b}return{cross:c,bdx1:h,bdx2:m,bdy:p,sign:u}}}))}function drawConstellationLabel(t,e){t.font=12..toString()+"px Arial";for(var a,n,r="#6c3483",i="white",o=1;o<conLab.length;o++)(a=getXY(conLab[o].ra,conLab[o].dec,e)).inChart&&(n=t.measureText(conLab[o].abbr).width,t.fillStyle=i,t.fillRect(a.x,a.y-12,n,12),t.fillStyle=r,t.fillText(conLab[o].abbr,a.x,a.y)),"ra2"in conLab[o]&&(a=getXY(conLab[o].ra2,conLab[o].dec2,e)).inChart&&(t.fillStyle=i,t.fillRect(a.x,a.y-12,n,12),t.fillStyle=r,t.fillText(conLab[o].abbr,a.x,a.y))}function drawPlanets(t,e,a){var n;tipsEnabled&&(n="timeNorth"==a.timeId?0:"timeCentral"==a.timeId?1:2);var r=a.pDraw,i=2*Math.PI;t.font="20px Arial";for(var o=0;o<9;o++){var d=getXY(r.planets[o].ra2000,r.planets[o].dec2000,a);if(d.inChart){var l=d.x,s=d.y,c=String.fromCharCode(r.code[o]);if(t.fillStyle=r.color[o],t.fillText(c,l+r.offset[o].x,s+r.offset[o].y),t.beginPath(),t.arc(l,s,r.size[o],0,i),t.fill(),tipsEnabled){var h=.5*t.measureText(c).width;h=Math.max(h,10),tips[n].push({x:l+r.offset[o].x+h,y:s+r.offset[o].y-10,r2:h*h,object:r.pName[o],pIndex:o})}}}}function getXY(t,e,a){switch(a.projection){case"stereographic":return getXYstereographic(t,e,a);case"Mollweide":return getXYmollweide(t,e,a)}}function getXYstereographic_special(t,e,a){let n=t-a.centralRa,r=a.centralDec,i=Math.sin(n),o=Math.cos(n),d=Math.cos(r),l=Math.sin(r),s=Math.cos(e),c=Math.sin(e),h=1+l*c+d*s*o,p=a.r*(d*c-l*s*o)/h,m=a.r*s*i/h,u=p*p+m*m<=a.r2;return{x:a.xc+p,y:a.yc-m,inChart:u}}function getXYstereographic(t,e,a){if(Math.abs(a.angRadius-.5*Math.PI)<1e-5)return getXYstereographic_special(t,e,a);let n=a.centralRa,r=a.centralDec,i=Math.cos(t-n),o=Math.sin(t-n),d=Math.cos(r),l=Math.sin(r),s=Math.cos(e),c=Math.sin(e),h=Math.acos(c*l+s*d*i),p=i*l*s-c*d,m=o*s,u=Math.sqrt(p*p+m*m),y=1,f=0;u>1e-10&&(y=p/u,f=m/u);let b=a.r*Math.tan(.5*h)/Math.tan(.5*a.angRadius);return p=a.xc-b*y,m=a.yc-b*f,{x:p,y:m,inChart:b<=a.r}}function getXYmollweide(t,e,a){let n=(t-a.centralRa)/Math.PI;n-=2*Math.floor(.5*(n+1));let r=mollweideThetaSolver(e);return{x:a.xc-a.r*n*Math.cos(r),y:a.yc-.5*a.r*Math.sin(r),inChart:!0,theta:r}}function mollweideThetaSolver(t){if(Math.abs(Math.abs(t)-.5*Math.PI)<1e-10)return t;let e,a=Math.PI*Math.sin(Math.abs(t)),n=2*Math.abs(t),r=0,i=1e-15;for(r=0;r<20&&(e=n-(n+Math.sin(n)-a)/(1+Math.cos(n)),!(Math.abs(e-n)<i));r++)n=e;if(20==r){let t=0,n=Math.PI;for(var o=0;o<50;o++){e=.5*(t+n);var d=e+Math.sin(e)-a;if(d<0?t=e:n=e,n-t<i||Math.abs(d)<i){r+=o;break}}}return t<0&&(e=-e),.5*e}function addLine(t,e,a,n,r,i){let o,d;switch(i.projection){case"stereographic":o=getXYstereographic(e,a,i),d=getXYstereographic(n,r,i),addLineXY(t,o.x,o.y,d.x,d.y,i);break;case"Mollweide":o=getXYmollweide(e,a,i),d=getXYmollweide(n,r,i);let l=i.centralRa-Math.PI,s=(e-l)/Math.PI,c=(n-l)/Math.PI,h=(e-n)/Math.PI;s-=2*Math.floor(.5*(s+1)),c-=2*Math.floor(.5*(c+1)),h-=2*Math.floor(.5*(h+1));let p=Math.abs(s)+Math.abs(c)-Math.abs(h);s*c<0&&p<1e-5?addLinesXYmollweideAcross(t,o,d,i):(t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(d.x,d.y),t.stroke())}}function addLineXY(t,e,a,n,r,i){var o=function(t){return t*t},d=o(e-i.xc)+o(a-i.yc),l=o(n-i.xc)+o(r-i.yc);if(!(d>i.r2&&l>i.r2)){var s=e,c=n,h=a,p=r;if(d>i.r2||l>i.r2){var m,u=(e-i.xc)*(n-i.xc)+(a-i.yc)*(r-i.yc),y=o(e-n)+o(a-r),f=d-u;d<=i.r2?(c=e+(m=(f+Math.sqrt(f*f+y*(i.r2-d)))/y)*(n-e),p=a+m*(r-a)):(s=e+(m=(f-Math.sqrt(f*f+y*(i.r2-d)))/y)*(n-e),h=a+m*(r-a))}t.beginPath(),t.moveTo(s,h),t.lineTo(c,p),t.stroke()}}function addLinesXYmollweideAcross(t,e,a,n){let r=(e.x-n.xc)/n.r,i=(a.x-n.xc)/n.r,o=(e.y-n.yc)/n.r,d=(a.y-n.yc)/n.r;r>0&&(i+=2*Math.cos(a.theta)),r<0&&(i-=2*Math.cos(a.theta));let l=i-r,s=d-o,c=r*l+4*o*s,h=1-r*r-4*o*o;var p=h/(c+Math.sqrt(c*c+h*(l*l+4*s*s)));let m=r+p*l,u=o+p*s,y=m*n.r+n.xc,f=u*n.r+n.yc;t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(y,f),t.stroke(),y=-m*n.r+n.xc,t.beginPath(),t.moveTo(y,f),t.lineTo(a.x,a.y),t.stroke()}function displayPopup(t,e){var a,n;"canvasNorth"==e?(a=0,n="#tipNorth"):"canvasCentral"==e?(a=1,n="#tipCentral"):(a=2,n="#tipSouth");var r,i,o=document.getElementById(e).getBoundingClientRect(),d=t.clientX-o.left,l=t.clientY-o.top,s=!1;for(r=0;r<tips[a].length;r++){var c=d-(i=tips[a][r]).x,h=l-i.y;if(c*c+h*h<i.r2){s=!0;break}}if(s){$(n+"Text").empty();var p={tipInd:a,tipId:n},m=date.T+date.dT;m>-50&&m<10&&(p.nu=nutation(m)),"star"==i.object?displayPopupStar(i,p):"Sun"==i.object?displayPopupSun(i,p):"Moon"==i.object?displayPopupMoon(i,p):displayPopupPlanet(i,p),$(n).css("left",i.x+3+"px"),$(n).css("top",i.y+3+"px"),$(n).show()}}function closePopup(t){var e="#"+t;$(e).hide(),$(e+"text").empty(),$(e).css("left","-200px")}function displayPopupSun(t,e){var a,n=date.T+date.dT;if(highPrecCalInTips)a=planetGeoVSOP(n,"Sun",!1);else{a=planetPos(n,[!1,!1,!0,!1,!1,!1,!1,!1])[2]}var r=180/Math.PI,i=12/Math.PI,o=constellationAbbrNames()[get_constellation(a.ra2000,a.dec2000)],d=convertDM(a.ra2000*i,"hm"),l=convertDM(a.dec2000*r,"dm"),s=precession_matrix(0,n),c=precessed_ra_dec(a.ra2000,a.dec2000,s);if("nu"in e){c=precessed_ra_dec(c.ra,c.dec,e.nu);var h={T:n,m:e.nu};c=aberration(c.ra,c.dec,h)}var p=convertDM(c.ra*i,"hm"),m=convertDM(c.dec*r,"dm"),u=31.965/a.rGeo,y="<table>";y+='<tr><th colspan="2">Sun</th></tr>',y+="<tr><td>Distance</td> <td>"+a.rGeo.toFixed(3)+" AU</td></tr>",y+="<tr><td>Angular Diameter</td> <td>"+u.toFixed(1)+"'</td></tr>",y+="<tr><td>Ra, Dec (J2000)</td> <td>"+d+", "+l+"</td></tr>",y+="nu"in e?"<tr><td>App. Ra, Dec (of date)</td> <td>"+p+", "+m+"</td></tr>":"<tr><td>Ra, Dec (of date)</td> <td>"+p+", "+m+"</td></tr>",y+="<tr><td>Constellation</td><td>"+o+"</td></tr>",$(e.tipId+"Text").append(y)}function displayPopupMoon(t,e){var a,n,r,i,o,d,l=date.T+date.dT;if(highPrecCalInTips){r=(a=MoonPosElpMpp02(l,!0)).rGeo;d=(n=planetPos(l,[!1,!1,!0,!1,!1,!1,!1,!1])[2]).rGeo,o=n.lam2000,i=a.lam2000}else a=MediumMoon(l),o=(n=MiniSun(l)).lam,d=1,i=a.lam,r=a.rGeo;var s=180/Math.PI,c=12/Math.PI,h=constellationAbbrNames()[get_constellation(a.ra2000,a.dec2000)],p=convertDM(a.ra2000*c,"hm"),m=convertDM(a.dec2000*s,"dm"),u={ra:a.ra,dec:a.dec};if("nu"in e){u=precessed_ra_dec(u.ra,u.dec,e.nu);var y={T:l,m:e.nu};u=aberration(u.ra,u.dec,y)}var f=convertDM(u.ra*c,"hm"),b=convertDM(u.dec*s,"dm"),M=moonIlluminated(n.ra,n.dec,a.ra,a.dec,o,i,r,d),g=M.illuminated.toFixed(2),v=M.phase,x=M.elongTxt,S=M.mag.toFixed(1),T="<table>";T+='<tr><th colspan="2">Moon</th></tr>',T+="<tr><td>Geocentric Distance</td><td>"+r.toFixed(0)+" km ("+(r/6371).toFixed(1)+"R<sub>&oplus;</sub>)</td></tr>",T+="<tr><td>Angular Diameter</td> <td>"+(3475/r*10800/Math.PI).toFixed(1)+"'</td></tr>",T+="<tr><td>Phase</td> <td>"+v+"</td></tr>",T+="<tr><td>Illuminated</td> <td>"+g+"</td> </tr>",T+="<tr><td>Apparent Magnitude</td> <td>"+S+"</td> </tr>",T+="<tr><td>Solar Elongation</td> <td>"+x+"</td> </tr>",T+="<tr><td>Geocentric Ra, Dec (J2000)</td> <td>"+p+", "+m+"</td></tr>",T+="nu"in e?"<tr><td>App. Geocentric Ra, Dec (of date)</td> <td>"+f+", "+b+"</td></tr>":"<tr><td>Geocentric Ra, Dec (of date)</td> <td>"+f+", "+b+"</td></tr>",T+="<tr><td>Constellation</td><td>"+h+"</td></tr>",$(e.tipId+"Text").append(T)}function displayPopupPlanet(t,e){var a=[!1,!1,!0,!1,!1,!1,!1,!1],n=t.pIndex-1;t.pIndex<4&&n--,a[n]=!0;var r,i,o=date.T+date.dT;if(highPrecCalInTips)i={rGeo:(r=planetGeoVSOP(o,t.object,!0)).dSunEarth,lam2000:r.lamSun2000,bet2000:r.betSun2000};else{var d=planetPos(o,a);r=d[n],i=d[2]}var l=r.rHelio,s=r.rGeo,c=180/Math.PI,h=12/Math.PI,p=constellationAbbrNames()[get_constellation(r.ra2000,r.dec2000)],m=convertDM(r.ra2000*h,"hm"),u=convertDM(r.dec2000*c,"dm"),y={ra:r.ra,dec:r.dec};if("nu"in e){y=precessed_ra_dec(y.ra,y.dec,e.nu);var f={T:o,m:e.nu};y=aberration(y.ra,y.dec,f)}var b=convertDM(y.ra*h,"hm"),M=convertDM(y.dec*c,"dm"),g=elongationPhase(r,i),v=g.elongation,x=g.illuminated,S={object:t.object,i:g.phaseAng,rHelio:l,rGeo:s,T:o,planet:r,sun:i},T=planetMag(S),I={Mercury:6.726865375887558,Venus:16.68838398040351,Mars:9.3468517633725,Jupiter:192.78588394427936,Saturn:160.5799887548923,Uranus:69.93800100978119,Neptune:67.89738430970871}[t.object]/s,C="<table>";C+='<tr><th colspan="2">'+t.object+"</th></tr>",C+="<tr><td>Heliocentric Distance</td> <td>"+l.toFixed(3)+" AU</td></tr>",C+="<tr><td>Geocentric Distance</td> <td>"+s.toFixed(3)+" AU</td></tr>",C+="<tr><td>Angular Diameter</td> <td>"+I.toPrecision(3)+'"</td></tr>',C+="<tr> <td>Elongation</td> <td>"+v+"</td></tr>",t.pIndex<5&&(C+="<tr><td>Illuminated</td> <td>"+x+"</td></tr>"),C+="<tr><td>Apparent Magnitude</td> <td>"+T.toFixed(1)+"</td></tr>",C+="<tr><td>Ra, Dec (J2000)</td> <td>"+m+", "+u+"</td></tr>",C+="nu"in e?"<tr><td>App. Ra, Dec (of date)</td> <td>"+b+", "+M+"</td></tr>":"<tr><td>Ra, Dec (of date)</td> <td>"+b+", "+M+"</td></tr>",C+="<tr><td>Constellation</td><td>"+p+"</td></tr>",$(e.tipId+"Text").append(C)}function displayPopupStar(t,e){var a=brightStars(),n=a[t.starInd],r=date.T+date.dT,i=a[0].Tepoch,o=r-i,d=n.x+n.vx*o,l=n.y+n.vy*o,s=n.z+n.vz*o,c=Math.sqrt(d*d+l*l+s*s);if(r>-50&&r<10){var h=planetPos(r,[!1,!1,!0,!1,!1,!1,!1,!1])[2],p=h.rGeo*Math.PI/648e3;d-=-p*Math.cos(h.ra2000)*Math.cos(h.dec2000),l-=-p*Math.sin(h.ra2000)*Math.cos(h.dec2000),s-=-p*Math.sin(h.dec2000),c=Math.sqrt(d*d+l*l+s*s)}var m=180/Math.PI,u=12/Math.PI,y=Math.atan2(l,d),f=Math.asin(s/c),b=convertDM(y*u,"hm"),M=convertDM(f*m,"dm"),g=constellationAbbrNames(),v=g[get_constellation(y,f)],x=g[n.con];v!=x&&(v=x+" (2000), "+v+" ("+date.yyyy+")");var S=precession_matrix(i,o),T=S.p11*d+S.p12*l+S.p13*s,I=S.p21*d+S.p22*l+S.p23*s,C=S.p31*d+S.p32*l+S.p33*s,w=Math.atan2(I,T),P=Math.asin(C/c);if("nu"in e){var A=precessed_ra_dec(w,P,e.nu),D={T:r,m:e.nu};w=(A=aberration(A.ra,A.dec,D)).ra,P=A.dec}var k,L=convertDM(w*u,"hm"),G=convertDM(P*m,"dm"),R="<table>",_=n.name,E=3.2616*c,F="";k=n.dist2000>=99e3?"?":c.toPrecision(4)+" pc ("+E.toPrecision(4)+" ly)","bayer"in n&&"<"!=_.slice(0,1)&&(_+=", "+n.bayer+" "+n.con);var Y=n.mag2000.toFixed(2),N="Mag.",X=0;if(n.dist2000<99e3){var j=n.mag2000+5-5*Math.LOG10E*Math.log(n.dist2000);X=5*Math.LOG10E*Math.log(c/n.dist2000),N+=", Abs. Mag.",Y=(Y=n.mag2000+X).toFixed(2)+", "+j.toFixed(2)}if("varMax"in n&&"varMin"in n){var U=parseFloat(n.varMax)+X,z=parseFloat(n.varMin)+X;F=U.toFixed(2)+" &ndash; "+z.toFixed(2)}R+='<tr><th colspan="2">'+_+"</th></tr>",R+="<tr><td>"+N+"</td> <td>"+Y+"</td></tr>",""!=F&&(R+="<tr><td>Variable</td> <td>"+F+"</td></tr>"),R+="<tr><td>Distance</td> <td>"+k+"</td></tr>","spect"in n&&(R+="<tr><td>Spec, col. ind.</td> <td>"+n.spect,"colorInd"in n&&(R+=", "+n.colorInd),R+="</td></tr>"),R+="<tr><td>Constellation</td> <td>"+v+"</td></tr>",R+="<tr><td>Ra, Dec (J2000)</td> <td>"+b+", "+M+"</td></tr>",R+="nu"in e?"<tr><td>App. Ra, Dec (of date)</td> <td>"+L+", "+G+"</td></tr>":"<tr><td>Ra, Dec (of date)</td> <td>"+L+", "+G+"</td></tr>",R+="</table>",$(e.tipId+"Text").append(R)}function setupDrawingParameters(){let t=-4/6.5;return{color:["red","orange","maroon","#FF00FF","red","brown","brown","#7277e6","#7277e6"],code:[9788,9789,9791,9792,9794,9795,9796,9954,9798],size:[1,2,1,2,2,2,2,2,2],offset:[{x:-10,y:7},{x:-10,y:7},{x:-5,y:7},{x:-7,y:0},{x:-7,y:2},{x:-10,y:7},{x:-5,y:7},{x:-10,y:3},{x:-8,y:5}],pName:["Sun","Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune"],raGridColor:["#ff8080","#ffcc00","#4d79ff","#ac7339","#cccccc"],starMagA:t,starMagB:4.076923076923077}}function addLegend(t){var e,a,n,r,i=document.getElementById("legend"),o=i.getContext("2d");o.clearRect(0,0,i.width,i.height),o.font="20px Arial",o.fillStyle="black",o.fillText("Magnitude scale:",0,20);var d=2*Math.PI;for(e=-1;e<6;e++){a=t.starMagA*e+t.starMagB,n=180+40*(e+1);var l=-20;-1==e&&(l=-22),o.fillText(e.toString(),n+l,20),o.beginPath(),o.arc(n,15,a,0,d),o.fill()}o.fillText("Planet symbols:   Sun",0,50),o.fillText("Moon",270,50),o.fillText("Mercury",380,50),o.fillText("Venus",160,75),o.fillText("Mars",270,75),o.fillText("Jupiter",380,75),o.fillText("Saturn",160,100),o.fillText("Uranus",270,100),o.fillText("Neptune",380,100),o.fillStyle=t.color[0],n=195,r=50,o.fillText(String.fromCharCode(t.code[0]),n,r),o.beginPath(),o.arc(n-t.offset[0].x,r-t.offset[0].y,t.size[0],0,d),o.fill(),o.fillStyle=t.color[1],n=320,o.fillText(String.fromCharCode(t.code[1]),n,r),o.beginPath(),o.arc(n-t.offset[1].x,r-t.offset[1].y,t.size[1],0,d),o.fill(),o.fillStyle=t.color[2],n=455,o.fillText(String.fromCharCode(t.code[2]),n,r),o.beginPath(),o.arc(n-t.offset[2].x,r-t.offset[2].y,t.size[2],0,d),o.fill(),o.fillStyle=t.color[3],n=220,r=75,o.fillText(String.fromCharCode(t.code[3]),n,r),o.beginPath(),o.arc(n-t.offset[3].x,r-t.offset[3].y,t.size[3],0,d),o.fill(),o.fillStyle=t.color[4],n=320,o.fillText(String.fromCharCode(t.code[4]),n,r),o.beginPath(),o.arc(n-t.offset[4].x,r-t.offset[4].y,t.size[4],0,d),o.fill(),o.fillStyle=t.color[5],n=445,o.fillText(String.fromCharCode(t.code[5]),n,r),o.beginPath(),o.arc(n-t.offset[5].x,r-t.offset[5].y,t.size[5],0,d),o.fill(),o.fillStyle=t.color[6],n=225,r=100,o.fillText(String.fromCharCode(t.code[6]),n,r),o.beginPath(),o.arc(n-t.offset[6].x,r-t.offset[6].y,t.size[6],0,d),o.fill(),o.fillStyle=t.color[7],n=335,o.fillText(String.fromCharCode(t.code[7]),n,r),o.beginPath(),o.arc(n-t.offset[7].x,r-t.offset[7].y,t.size[7],0,d),o.fill(),o.fillStyle=t.color[8],n=460,o.fillText(String.fromCharCode(t.code[8]),n,r),o.beginPath(),o.arc(n-t.offset[8].x,r-t.offset[8].y,t.size[8],0,d),o.fill(),n=0,r=130,o.beginPath(),o.moveTo(n,r),o.lineTo(n+40,r),o.strokeStyle=t.raGridColor[0],o.stroke(),o.font="16px Arial",o.fillStyle="black",o.fillText("Ra = 0h",n+45,r+8),n=120,r=130,o.beginPath(),o.moveTo(n,r),o.lineTo(n+40,r),o.strokeStyle=t.raGridColor[1],o.stroke(),o.font="16px Arial",o.fillStyle="black",o.fillText("Ra = 6h",n+45,r+8),n=240,r=130,o.beginPath(),o.moveTo(n,r),o.lineTo(n+40,r),o.strokeStyle=t.raGridColor[2],o.stroke(),o.font="16px Arial",o.fillStyle="black",o.fillText("Ra = 12h",n+45,r+8),n=370,r=130,o.beginPath(),o.moveTo(n,r),o.lineTo(n+40,r),o.strokeStyle=t.raGridColor[3],o.stroke(),o.font="16px Arial",o.fillStyle="black",o.fillText("Ra = 18h",n+45,r+8)}function displayAnimationSetup(t){var e="#"+t;$("button.menu").attr("disabled",!0),$("button.setupAnimate").attr("disabled",!0),$("button.controlAnimate").attr("disabled",!0),$(e).empty(),$(e).slideDown();var a="<h2>Animation Setup</h2>";$(e).append(a),a='<form name="animSetup" action="" method="get">',a+="<table>",a+='<tr><td colspan="3"><b>Start Time</b></td></tr>',a+='<tr><td>Year: <input type="number" id="yearAnim" step="1" min="-200000" max="200000" /></td>',a+='<td>Month: <input type="number" id="monthAnim" step="1" min="1" max="12" /></td>',a+='<td>Day: <input type="number" id="dayAnim" step="1" min="1" max="31" /></td></tr>',a+='<tr><td>Hour: <input type="number" id="hourAnim" step="1" min="0" max="23" /></td>',a+='<td>Minute: <input type="number" id="minuteAnim" step="1" min="0" max="59" /></td>',a+='<td>Second: <input type="number" id="secondAnim" step="any" min="0" max="60" />UT</td></tr>',a+='<tr><td colspan="3">Choose time step/frame: <input type="radio" id="radioCustom" value="custom" onclick="animRadioClick(',a+="'custom')",a+='" />Custom &nbsp;&nbsp;&nbsp;<input type="radio" id="radioYear" value="year" onclick="animRadioClick(',a+="'year')",a+='" />365.25 days&nbsp;&nbsp;&nbsp;<input type="radio" id="radioCentury" value="century" onclick="animRadioClick(',a+="'century')",a+='" />36525 days (100 years)<br />',a+='<input type="number" id="timeStepAnim" step="any" min="-36525" max="36525" /> days</td></tr>',a+='<tr><td colspan="3">Time between 2 frames: <input type="number" id="frameRateAnim" step="1" min="1" max="1000" /> ms</td></tr>',a+="</table><br />",a+='<p><input type="button" value="Submit" onclick="animationSetup(this.form,',a+="'"+t+"')",a+='" /></p>',a+="</form>",$(e).append(a),a='<div id="animationErrorlocs"></div>',$(e).append(a),a="<p>Note:",a+="<ul>",a+="<li>Time step/frame is the time between two successive frames in the animation.</li>",a+="<li>Time between two frames determines how frequently the star charts will be updated during the animation. It can be as fast as 1 ms, but the charts may not be fast enough to be drawn in 1 ms, depending on the processor speed.</li>",a+="<li>The positions of the Sun, Moon and planets are only accurate for years between -3000 and 3000.</li>",a+="<li>If you choose time step/frame to be 36525 days (1 Julian century), the time soon goes beyond the range in which the positions of the Sun, Moon and planets are accurate. It is better to turn off displaying the Sun, Moon and planets before playing the animation. Note also that the constellation lines will be distorted as stars move away from their current positions as a result of proper motions.</li>",a+="<li>The animation will stop when year goes beyond 200,000 since the formula for the precession becomes inaccurate after that time.",a+="</ul></p>",$(e).append(a),$("#yearAnim").val(date.yyyy),$("#monthAnim").val(date.mm),$("#dayAnim").val(date.dd),$("#hourAnim").val(date.h),$("#minuteAnim").val(date.m),$("#secondAnim").val(date.s.toFixed(3)),$("#timeStepAnim").val(animateDtStep),$("#frameRateAnim").val(frameRate),$("#radioCustom").prop("checked",!1),$("#radioYear").prop("checked",!1),$("#radioDay").prop("checked",!1),Math.abs(animateDtStep-365.25)<1e-10?($("#radioYear").prop("checked",!0),$("#timeStepAnim").val(365.25),$("#timeStepAnim").prop("disabled",!0)):Math.abs(animateDtStep-36525)<.001?($("#radioCentury").prop("checked",!0),$("#timeStepAnim").val(36525),$("#timeStepAnim").prop("disabled",!0)):($("#radioCustom").prop("checked",!0),$("#timeStepAnim").prop("disabled",!1))}function animRadioClick(t){switch($("#radioCustom").prop("checked",!1),$("#radioYear").prop("checked",!1),$("#radioCentury").prop("checked",!1),t){case"custom":$("#radioCustom").prop("checked",!0),$("#timeStepAnim").prop("disabled",!1);break;case"year":$("#radioYear").prop("checked",!0),$("#timeStepAnim").val(365.25),$("#timeStepAnim").prop("disabled",!0);break;case"century":$("#radioCentury").prop("checked",!0),$("#timeStepAnim").val(36525),$("#timeStepAnim").prop("disabled",!0)}}function animationSetup(t,e){var a=parseInt(t.yearAnim.value),n=parseInt(t.monthAnim.value),r=parseInt(t.dayAnim.value),i=parseInt(t.hourAnim.value),o=parseInt(t.minuteAnim.value),d=parseFloat(t.secondAnim.value),l=parseFloat(t.timeStepAnim.value),s=parseInt(t.frameRateAnim.value),c="#animationErrorlocs";$(c).empty();var h=-2e5,p=2e5,m="Invalid year! Please enter an integer between "+h+" and "+p+". Note that 0 means 1 BCE, -1 means 2 BCE and so on. Note that the positions of the Sun, Moon and planets are only accurate for years between -3000 and 3000.";if(sanityCheck(a,"#yearAnim",h,p,m,c),h=1,p=12,m="Invalid month! Month must be an integer between 1 and 12.",sanityCheck(n,"#monthAnim",h,p,m,c),h=1,p=31,m="Invalid day! Day must be an integer between 1 and 31.",sanityCheck(r,"#dayAnim",h,p,m,c),h=0,p=23,m="Invalid hour! Hour must be an integer between 0 and 23.",sanityCheck(i,"#hourAnim",h,p,m,c),h=0,p=59,m="Invalid minute! Minute must be an integer between 0 and 59.",sanityCheck(o,"#minuteAnim",h,p,m,c),h=0,p=60,m="Invalid second! Second must be a number between 0 and 60.",sanityCheck(d,"#secondAnim",h,p,m,c),m="Invalid time step/frame! Please enter a number between "+(h=-36525)+" and "+(p=36525)+".",sanityCheck(l,"#timeStepAnim",h,p,m,c),m="Invalid time between 2 frames! Please enter an integer between "+(h=1)+" and "+(p=1e3)+".",sanityCheck(s,"#frameRateAnim",h,p,m,c),""==$(c).text()){var u="#"+e;$(u).slideUp(),$(u).empty(),$("button.menu").attr("disabled",!1),$("button.setupAnimate").attr("disabled",!1),$("button.controlAnimate").attr("disabled",!1);var y=getDm(a,n,r,0),f=CalDat(y),b=generateTimeString(i,o,d),M=(y+=(i+o/60+d/3600)/24)/36525,g=DeltaT(M);date={yyyy:f.yy,mm:f.mm,dd:f.dd,h:i,m:o,s:d,dateString:f.dateString,timeString:b,D:y,T:M,dT:g},animateDtStep=l,frameRate=s,starCharts()}}function Animate(){var t="#animateNorth",e="#animateCentral",a="#animateSouth";"Play Animation"==$(t).text()?($(t).text("Stop Animation"),$(e).text("Stop Animation"),$(a).text("Stop Animation"),$("button.menu").attr("disabled",!0),$("button.setupAnimate").attr("disabled",!0),$("button.controlAnimate").attr("disabled",!0),$(t).attr("disabled",!1),$(e).attr("disabled",!1),$(a).attr("disabled",!1),tipsEnabled=!1,tips[0].length=0,tips[1].length=0,tips[2].length=0,$(".animationStop").empty(),clearInterval(animate_id),animate_id=setInterval((function(){playAnimation(1)}),frameRate)):(clearInterval(animate_id),$(t).text("Play Animation"),$(e).text("Play Animation"),$(a).text("Play Animation"),$("button.menu").attr("disabled",!1),$("button.setupAnimate").attr("disabled",!1),$("button.controlAnimate").attr("disabled",!1),tipsEnabled=!0,starCharts())}function playAnimation(t){var e=t*animateDtStep;date.D+=e,date.T=date.D/36525,date.dT=DeltaT(date.T);var a=CalDat(date.D);date.yyyy=a.yy,date.mm=a.mm,date.dd=a.dd,date.dateString=a.dateString;var n=24*(e-Math.floor(e)),r=date.h+date.m/60+date.s/3600+n;if(r-=24*Math.floor(r/24),date.h=Math.floor(r),date.m=Math.floor(60*(r-date.h)),date.s=3600*(r-date.h-date.m/60),date.timeString=generateTimeString(date.h,date.m,date.s),Math.abs(date.yyyy)>2e5){clearInterval(animate_id);return $("#animateNorth").text("Play Animation"),$("#animateCentral").text("Play Animation"),$("#animateSouth").text("Play Animation"),$("button.menu").attr("disabled",!1),$("button.setupAnimate").attr("disabled",!1),$("button.controlAnimate").attr("disabled",!1),$(".warning").append('<p style="color:red;" class="animationStop">Animation stops since the formula used for precession is only valid between the years -200,000 and 200,000.</p>'),tipsEnabled=!0,void starCharts()}starCharts()}